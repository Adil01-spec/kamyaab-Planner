
## Strategic Review Export

### Overview
This feature introduces a professional PDF export capability on the `/plan` page that allows users to generate a comprehensive, shareable document of their plan and execution insights. This is the first feature designed to make the "Pro" tier tangibly valuable.

**Core Principle:** "I could show this to a client, manager, or investor."

---

### Current State Analysis

**Existing PDF Export:**
- `src/lib/progressPdfExport.ts` - Exports progress history (historical trends, plan comparisons)
- Uses `jsPDF` library (already installed)
- Called from `ProgressProof.tsx` component

**Plan Data Structure (in `plan_json`):**
- `overview`, `total_weeks`, `weeks[]`, `milestones[]`, `motivation[]`
- `is_strategic_plan`, `strategy_overview`, `assumptions`, `risks`
- `reality_check` - cached AI critique (feasibility, risk signals, focus gaps)
- `execution_insights` - cached execution analysis (diagnosis, patterns, suggestions)

**Pro Feature Gating:**
- `FEATURE_REGISTRY` in `productTiers.ts` defines feature tiers
- `ProFeatureIndicator` shows subtle indicators
- `hasFeatureAccess()` checks if user has access
- `trackFeatureInterest()` logs interest for analytics

---

### Architecture Approach

```text
+-------------------+     +-------------------+     +-------------------+
|   Plan.tsx        | --> | StrategicReview   | --> | strategicReview   |
|  (Export button   |     | ExportButton      |     | PdfExport.ts      |
|   in header area) |     | (UI + Pro gate)   |     | (PDF generation)  |
+-------------------+     +-------------------+     +-------------------+
```

**Key Design Decisions:**
1. Create a new dedicated PDF export file (`strategicReviewPdfExport.ts`) rather than extending the existing progress export
2. Add export button near the plan header/overview section (intentional, not flashy)
3. Use soft Pro gating - visible to all, calm upsell for Free users
4. Export is strictly read-only - no data modifications

---

### Files to Create

| File | Description |
|------|-------------|
| `src/lib/strategicReviewPdfExport.ts` | Main PDF generation logic for Strategic Review export |
| `src/components/StrategicReviewExportButton.tsx` | Export button component with Pro gating and loading states |

### Files to Modify

| File | Change |
|------|--------|
| `src/lib/productTiers.ts` | Add `strategic-review-export` feature to registry |
| `src/pages/Plan.tsx` | Add StrategicReviewExportButton in plan overview section |

---

### Technical Implementation

#### Step 1: Register Feature in Product Tiers

**File:** `src/lib/productTiers.ts`

Add new feature entry to `FEATURE_REGISTRY`:

```typescript
'strategic-review-export': {
  id: 'strategic-review-export',
  name: 'Strategic Review Export',
  tier: 'pro',
  category: 'export',
  description: 'Export professional plan and insights summary as PDF',
},
```

---

#### Step 2: Create PDF Export Logic

**File:** `src/lib/strategicReviewPdfExport.ts`

A comprehensive PDF generator that includes all specified content sections:

**Export Configuration Interface:**
```typescript
interface StrategicReviewExportConfig {
  // Plan metadata
  projectTitle: string;
  projectDescription?: string;
  planningMode: 'Strategic' | 'Standard';
  createdAt: string;
  scenarioContext?: ScenarioTag;
  
  // User info
  userName?: string;
  
  // Plan data
  planData: PlanData;
  
  // Cached insights (optional)
  realityCheck?: RealityCritique;
  executionInsights?: ExecutionInsightsData;
}
```

**PDF Sections (in order):**

1. **Header**
   - "Strategic Review" title
   - Generated date
   - User name (if available)

2. **Plan Overview**
   - Project title
   - Description
   - Planning mode (Standard / Strategic)
   - Creation date
   - Scenario context (if available)

3. **Strategy Section (Strategic Plans Only)**
   - Strategy overview (objective, why now, success definition)
   - Key assumptions
   - Risks & blind spots (with mitigations)
   - Strategic milestones

4. **Task Structure**
   - Tasks grouped by week
   - Shows: task title, priority, completion status, time spent
   - Respects current user-reordered state

5. **Execution Insights (If Generated)**
   - Time estimation pattern
   - Effort distribution insight
   - Productivity patterns (peak, bottlenecks, strengths)
   - Forward suggestion
   - Execution diagnosis (primary mistake, secondary pattern, adjustment)

6. **Reality Check (If Generated)**
   - Feasibility assessment with badge
   - Risk signals with severity
   - Focus gaps
   - Strategic blind spots (if strategic)
   - De-prioritization suggestions

7. **Closing Summary**
   - Generated from execution data if available
   - "What worked" - derived from strengths/smooth patterns
   - "What slowed execution" - derived from bottlenecks/diagnosis
   - "What to adjust next cycle" - derived from forward suggestion/adjustment

8. **Footer**
   - Page numbers
   - "Generated by Kaamyab"

**Visual Design:**
- Use existing brand colors from `progressPdfExport.ts`
- Primary Green: `[14, 159, 110]` (#0E9F6E)
- Text: `[15, 23, 42]` (#0F172A)
- Muted: `[71, 85, 105]` (#475569)
- Clean section headers with accent bar
- Alternating row colors for task tables
- Professional typography (Helvetica)

---

#### Step 3: Create Export Button Component

**File:** `src/components/StrategicReviewExportButton.tsx`

A button component that handles:
- Pro gating with soft upsell
- Loading state during PDF generation
- Error handling with toast notifications
- Interest tracking for Free users

**Component Structure:**
```typescript
interface StrategicReviewExportButtonProps {
  planData: PlanData;
  planCreatedAt: string;
  projectTitle: string;
  projectDescription?: string;
  userName?: string;
  className?: string;
}
```

**Behavior:**
- **Pro Users:** Click generates PDF immediately
- **Free Users:** Click shows calm tooltip/toast with upsell message
- Shows `FileDown` or `Download` icon from Lucide
- Label: "Export Strategic Review"
- Subtext (on hover/tooltip): "Creates a professional summary of your plan and execution"

**Pro Gating UI:**
```typescript
const { hasAccess, isPro, trackInterest } = useFeatureAccess('strategic-review-export', planData);

// If Free user clicks:
if (!hasAccess) {
  trackInterest('attempted');
  toast({
    title: "Pro Feature",
    description: "Strategic Review Export is available with Strategic Planning. Upgrade to create professional plan summaries.",
  });
  return;
}
```

---

#### Step 4: Add Export Button to Plan Page

**File:** `src/pages/Plan.tsx`

Add the export button in the plan overview section (after the identity statement editor, before strategy section):

```tsx
{/* Overview with Identity Statement */}
<div className="animate-fade-in">
  <div className="flex items-start justify-between gap-4">
    <div className="flex-1">
      <h1 className="text-3xl font-bold text-foreground mb-2">Your AI Plan</h1>
      <p className="text-muted-foreground mb-3">{plan.overview}</p>
    </div>
    {/* Export Button - intentional placement */}
    <StrategicReviewExportButton
      planData={plan}
      planCreatedAt={planCreatedAt || ''}
      projectTitle={profile?.projectTitle || 'Untitled Project'}
      projectDescription={profile?.projectDescription}
      userName={profile?.fullName}
    />
  </div>
  <IdentityStatementEditor
    value={plan.identity_statement || ''}
    onChange={updateIdentityStatement}
  />
</div>
```

---

### Closing Summary Generation Logic

The closing summary is derived from existing data without AI regeneration:

```typescript
function generateClosingSummary(
  executionInsights: ExecutionInsightsData | undefined,
  realityCheck: RealityCritique | undefined
): ClosingSummary {
  return {
    what_worked: deriveWhatWorked(executionInsights),
    what_slowed: deriveWhatSlowed(executionInsights, realityCheck),
    what_to_adjust: deriveWhatToAdjust(executionInsights),
  };
}

function deriveWhatWorked(insights: ExecutionInsightsData | undefined): string[] {
  if (!insights) return [];
  const items: string[] = [];
  
  // From strengths
  if (insights.productivity_patterns?.strengths) {
    items.push(...insights.productivity_patterns.strengths.slice(0, 2));
  }
  
  // From effort pattern if positive
  if (insights.effort_distribution_insight?.pattern === 'smooth-sailing') {
    items.push('Maintained balanced effort distribution');
  }
  
  // From time estimation if accurate
  if (insights.time_estimation_insight?.pattern === 'accurate') {
    items.push('Estimation accuracy was consistent');
  }
  
  return items.slice(0, 3);
}

function deriveWhatSlowed(
  insights: ExecutionInsightsData | undefined,
  realityCheck: RealityCritique | undefined
): string[] {
  const items: string[] = [];
  
  // From bottlenecks
  if (insights?.productivity_patterns?.bottlenecks) {
    items.push(...insights.productivity_patterns.bottlenecks.slice(0, 2));
  }
  
  // From execution diagnosis
  if (insights?.execution_diagnosis?.primary_mistake) {
    items.push(insights.execution_diagnosis.primary_mistake.label);
  }
  
  // From high-severity risks
  const highRisks = realityCheck?.risk_signals?.items
    ?.filter(r => r.severity === 'high')
    .slice(0, 1);
  if (highRisks?.length) {
    items.push(highRisks[0].signal);
  }
  
  return items.slice(0, 3);
}

function deriveWhatToAdjust(insights: ExecutionInsightsData | undefined): string[] {
  const items: string[] = [];
  
  // From forward suggestion
  if (insights?.forward_suggestion) {
    items.push(insights.forward_suggestion.title);
  }
  
  // From adjustment
  if (insights?.execution_diagnosis?.adjustment) {
    items.push(insights.execution_diagnosis.adjustment.action);
  }
  
  return items.slice(0, 2);
}
```

---

### UX Specifications

| Element | Specification |
|---------|---------------|
| Button Label | "Export Strategic Review" |
| Button Style | `variant="outline"`, subtle appearance |
| Button Icon | `FileDown` from Lucide |
| Loading State | Shows `Loader2` spinner with "Generating..." text |
| Error State | Toast with "Export failed" message |
| Success State | Toast with "Report downloaded" message |
| Pro Indicator | Small star icon via `ProFeatureIndicator` |
| Free User Click | Toast with calm upsell copy |

**Button Placement:**
- Right side of plan overview header
- Aligns with the title row
- Does not compete with primary actions

---

### Guardrails (Enforced)

| Constraint | Implementation |
|------------|----------------|
| Read-only | Export reads current state, no mutations |
| No regeneration | Uses cached insights/reality check only |
| No plan modification | Purely client-side PDF generation |
| No timer/today impact | Isolated export logic in separate file |
| Error isolation | Try-catch around all PDF operations |

---

### Pro Gating Summary

| User Tier | Button Visible | Click Behavior |
|-----------|---------------|----------------|
| Pro (Strategic Plan) | Yes | Generates PDF immediately |
| Free (Standard Plan) | Yes | Shows tooltip upsell, tracks interest |
| No Plan | N/A | Button not rendered |

**Upsell Message (Toast):**
> "Strategic Review Export is available with Strategic Planning. Create professional summaries of your plans and execution insights."

---

### Implementation Order

1. Add `strategic-review-export` to `FEATURE_REGISTRY` in `productTiers.ts`
2. Create `src/lib/strategicReviewPdfExport.ts` with full PDF generation logic
3. Create `src/components/StrategicReviewExportButton.tsx` with Pro gating
4. Integrate button into `src/pages/Plan.tsx` in the overview section
5. Test with both Strategic and Standard plans

---

### Testing Checklist

**Export Content Accuracy:**
- [ ] Plan overview section includes all metadata
- [ ] Strategy section appears only for strategic plans
- [ ] Tasks grouped correctly by week with current order
- [ ] Completion status and time spent displayed
- [ ] Execution insights included if generated
- [ ] Reality check included if generated
- [ ] Closing summary derived correctly

**Pro Gating:**
- [ ] Pro users can export immediately
- [ ] Free users see upsell toast on click
- [ ] Interest tracked when Free user attempts
- [ ] ProFeatureIndicator shows star icon

**No Side Effects:**
- [ ] /today page unaffected
- [ ] Timers continue normally
- [ ] Task state unchanged
- [ ] No API calls except PDF generation

**Error Handling:**
- [ ] Graceful failure with toast on error
- [ ] Loading state displayed during generation
- [ ] Success toast on completion

---

### Summary

This implementation introduces a Strategic Review Export feature that:

- Creates a professional, shareable PDF of the user's plan and insights
- Uses existing cached data (no AI regeneration required)
- Implements soft Pro gating with interest tracking
- Maintains strict read-only behavior with no side effects
- Positions the export as a calm, intentional action fitting the executive tone

The export will feel credible and professional - something users would confidently share with clients, managers, or investors.
